<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>ZenInvest ç›£æ§ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0a1929; color: #e0e6ed; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        @media (max-width: 768px) { body { overflow: auto; height: auto; } }
        .table { color: #e0e6ed; border-color: #1e3a5f; margin-bottom: 0; }
        .table thead th { position: sticky; top: 0; z-index: 10; background-color: #0d2339; border-bottom: 2px solid #3e6b99; color: #94a3b8; font-weight: 700; padding: 18px 12px; }
        .table tbody td { padding: 15px 12px; vertical-align: middle; }
        .table-hover tbody tr:hover { color: #fff; background-color: #132f4c; }
        .up { color: #4ade80; font-weight: bold; }
        .down { color: #fb7185; font-weight: bold; }
        .crypto-name { font-size: 1.3rem; font-weight: bold; color: #fff; }
        .btn-currency { background-color: #0d2339; color: #94a3b8; border: 1px solid #3e6b99; }
        .btn-currency.active { background-color: #38bdf8; color: #0a1929; border-color: #38bdf8; font-weight: bold; }
        .risk-spectrum-container { width: 140px; height: 8px; background: #1e293b; border-radius: 4px; position: relative; margin-top: 5px; }
        .risk-gradient { width: 100%; height: 100%; background: linear-gradient(90deg, #4ade80 0%, #facc15 50%, #fb7185 100%); border-radius: 4px; opacity: 0.8; }
        .risk-pointer { width: 6px; height: 12px; background: #fff; position: absolute; top: -2px; transform: translateX(-50%); border-radius: 2px; }
        .btn-analyze { border: 1px solid #3e6b99; color: #94a3b8; padding: 2px 10px; border-radius: 15px; text-decoration: none; }
        .btn-analyze:hover { background: #38bdf8; color: #000; }
    </style>
</head>
<body>
    <div class="container-fluid py-4" style="max-width: 96%; height: 100vh; display: flex; flex-direction: column;">
        <div class="d-flex justify-content-between align-items-end mb-3">
            <div><h2 class="fw-bold mb-0 text-white">ğŸ’ ZenInvest ç›£æ§ç³»çµ±</h2></div>
            <div class="text-end">
                <div class="btn-group mb-2">
                    <button type="button" class="btn btn-currency active" id="btn-twd" onclick="setCurrency('TWD')">TWD</button>
                    <button type="button" class="btn btn-currency" id="btn-usd" onclick="setCurrency('USD')">USD</button>
                </div>
                <div class="d-flex align-items-center justify-content-end gap-3">
                    <span id="update-time" class="fs-4 fw-bold text-white">--:--:--</span>
                    <button id="refresh-btn" class="btn btn-outline-info fw-bold" onclick="manualRefresh()">ğŸ”„ æ›´æ–°</button>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2 mb-3">
            <input type="text" id="search-input" class="form-control bg-dark text-white border-secondary" placeholder="ğŸ” æœå°‹è³‡ç”¢..." style="max-width: 300px;">
            <a href="/social-sentiment" class="btn btn-outline-info">ğŸ“¡ è¨Šå™ªåˆ†é›¢å™¨</a>
        </div>
        
        <div class="table-responsive rounded shadow-lg mb-3 flex-grow-1" style="background-color: #0d2339;">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr><th class="text-center">æ’å</th><th>è³‡ç”¢åç¨±</th><th>å³æ™‚åƒ¹æ ¼ (<span id="price-header">TWD</span>)</th><th>24H æ¼²è·Œå¹…</th><th>é¢¨éšªæŒ‡æ•¸ (SFI)</th></tr>
                </thead>
                <tbody id="crypto-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        let allCryptoData = [], currentCurrency = 'TWD';
        document.getElementById('search-input').addEventListener('input', renderTable);
        function setCurrency(curr) { currentCurrency = curr; document.getElementById('price-header').innerText = curr; document.querySelectorAll('.btn-currency').forEach(btn => btn.classList.remove('active')); if(curr === 'TWD') document.getElementById('btn-twd').classList.add('active'); else document.getElementById('btn-usd').classList.add('active'); renderTable(); }
        async function fetchData() {
            try {
                const response = await fetch('/api/coingecko');
                const result = await response.json();
                document.getElementById('update-time').innerText = result.timestamp;
                if (!result.data) return;
                allCryptoData = result.data;
                renderTable();
            } catch (error) { console.error(error); }
        }
        function renderTable() {
            const tbody = document.getElementById('crypto-body'); tbody.innerHTML = ''; 
            const searchText = document.getElementById('search-input').value.toLowerCase().trim();
            const filteredData = allCryptoData.filter(c => c.name.toLowerCase().includes(searchText) || c.cn_name.toLowerCase().includes(searchText)).slice(0, 50);
            filteredData.forEach(coin => {
                let changeColor = coin.change >= 0 ? 'up' : 'down';
                let riskDisplay = '';
                if (coin.risk && coin.risk.score !== undefined) {
                    let score = coin.risk.score;
                    let msg = coin.risk.msg;
                    let scoreColor = score > 65 ? '#fb7185' : (score > 40 ? '#facc15' : '#4ade80');
                    let params = `name=${encodeURIComponent(coin.cn_name)}&corr=${coin.risk.corr}&score=${score}&beta=${coin.risk.beta}&lambda=${coin.risk.lambda}&level=${coin.risk.level}`;
                    riskDisplay = `<div class="d-flex align-items-center"><div><div class="d-flex justify-content-between mb-1" style="width: 140px;"><span style="font-size: 0.9rem; font-weight: bold; color: ${scoreColor};">${msg}</span><span style="font-size: 0.8rem; color: #64748b;">${score}/100</span></div><div class="risk-spectrum-container"><div class="risk-gradient"></div><div class="risk-pointer" style="left: ${score}%;"></div></div></div>${coin.symbol !== 'BTC' ? `<a href="/analysis/${coin.symbol}?${params}" class="btn-analyze ms-2">ğŸ“Š åˆ†æ</a>` : ''}</div>`;
                }
                let price = currentCurrency === 'TWD' ? coin.price_twd : coin.price_usd;
                let symbol = currentCurrency === 'TWD' ? 'NT$' : '$';
                tbody.innerHTML += `<tr class="update-flash"><td class="text-center text-muted fw-bold">${coin.rank}</td><td><div><div class="crypto-name">${coin.cn_name}</div><div class="crypto-symbol">${coin.symbol}</div></div></td><td class="fw-bold fs-5 text-white">${symbol} ${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4})}</td><td class="${changeColor}">${coin.change ? coin.change.toFixed(2) : '0.00'}%</td><td>${riskDisplay}</td></tr>`;
            });
        }
        setInterval(fetchData, 60000); async function manualRefresh() { await fetchData(); } fetchData(); 
    </script>
</body>
</html>