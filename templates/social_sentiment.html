<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>å…¨ç¶²ç¤¾ç¾¤è¨Šå™ªåˆ†é›¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #050b14; color: #e0e6ed; font-family: 'Segoe UI', Roboto, sans-serif; }
        .glass-card { background: rgba(16, 33, 65, 0.6); border: 1px solid rgba(56, 189, 248, 0.2); backdrop-filter: blur(12px); border-radius: 12px; margin-bottom: 20px; }
        .card-header { background: rgba(13, 35, 57, 0.8); border-bottom: 1px solid rgba(56, 189, 248, 0.2); color: #38bdf8; font-weight: bold; }
        .post-card { background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 15px; margin-bottom: 10px; border-radius: 6px; }
        .signal-post { border-left: 4px solid #4ade80; background: rgba(16, 33, 65, 0.4); }
        .noise-post { border-left: 4px solid #64748b; opacity: 0.5; filter: grayscale(0.8); }
        .keyword-badge { border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; background: rgba(0,0,0,0.3); display: inline-block; margin: 3px; font-size: 1rem; transition: 0.3s; }
        .keyword-badge:hover { background: rgba(56, 189, 248, 0.2); transform: scale(1.05); }
        .hot-keyword { border-color: #facc15; color: #facc15; }
        .stat-val { font-size: 3rem; font-weight: bold; }
        .btn-back { border: 1px solid #38bdf8; color: #38bdf8; text-decoration: none; padding: 5px 15px; border-radius: 20px; }
        .post-link { color: white; text-decoration: none; font-weight: 500; transition: 0.2s; display: block; }
        .post-link:hover { color: #38bdf8; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-white"><i class="fas fa-satellite-dish text-info"></i> å…¨ç¶²ç¤¾ç¾¤è¨Šå™ªåˆ†é›¢</h2>
            <a href="/" class="btn btn-back">è¿”å›</a>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="glass-card h-100 p-4 text-center d-flex flex-column justify-content-center">
                    <div class="text-muted mb-2">AI è¼¿æƒ…æƒ…ç·’</div>
                    <div class="stat-val" id="sentiment-score">--</div>
                    <div id="sentiment-status" class="mt-2 fs-5 badge bg-dark border border-secondary">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <div class="card-header">ğŸ“ˆ è¶¨å‹¢ (Live)</div>
                    <div class="card-body p-2"><div id="trend-chart" style="height: 150px;"></div></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card h-100">
                    <div class="card-header">ğŸ”¥ ç†±é–€è©±é¡Œ</div>
                    <div class="card-body" id="keyword-cloud"></div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-7">
                <div class="glass-card h-100">
                    <div class="card-header text-success"><span><i class="fas fa-wifi"></i> æœ‰æ•ˆè¨Šè™Ÿ (Signals)</span> <span class="badge bg-success" id="signal-count-badge">0</span></div>
                    <div class="card-body" id="signal-stream" style="height: 600px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="glass-card h-100">
                    <div class="card-header text-muted"><span><i class="fas fa-filter"></i> å·²éæ¿¾å™ªéŸ³ (Noise)</span> <span class="badge bg-secondary" id="noise-count-badge">0</span></div>
                    <div class="card-body" id="noise-stream" style="height: 600px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let timeData = [], sentimentData = [];
        Plotly.newPlot('trend-chart', [{ x: timeData, y: sentimentData, mode: 'lines', line: {color: '#38bdf8', width: 3} }], 
        { paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', margin: { t: 10, b: 30, l: 30, r: 10 }, xaxis: { showgrid: false }, yaxis: { gridcolor: '#1e3a5f', range: [-100, 100] } }, {displayModeBar: false});

        async function fetchSocialData() {
            try {
                const response = await fetch('/api/social-data');
                const data = await response.json();
                
                document.getElementById('signal-count-badge').innerText = data.signal_count;
                document.getElementById('noise-count-badge').innerText = data.noise_count;

                const scoreEl = document.getElementById('sentiment-score');
                scoreEl.innerText = data.sentiment_score;
                const statusEl = document.getElementById('sentiment-status');
                
                if(data.sentiment_score > 20) { 
                    scoreEl.style.color = '#4ade80'; statusEl.innerText = "è²ªå©ª (Greed)"; statusEl.className = "mt-2 fs-5 badge bg-success"; 
                } else if(data.sentiment_score < -20) { 
                    scoreEl.style.color = '#fb7185'; statusEl.innerText = "ææ…Œ (Fear)"; statusEl.className = "mt-2 fs-5 badge bg-danger"; 
                } else { 
                    scoreEl.style.color = '#e0e6ed'; statusEl.innerText = "ä¸­ç«‹ (Neutral)"; statusEl.className = "mt-2 fs-5 badge bg-secondary"; 
                }

                let now = new Date().toLocaleTimeString();
                timeData.push(now); sentimentData.push(data.sentiment_score);
                if(timeData.length > 15) { timeData.shift(); sentimentData.shift(); }
                Plotly.update('trend-chart', { x: [timeData], y: [sentimentData] });

                const kwContainer = document.getElementById('keyword-cloud');
                kwContainer.innerHTML = '';
                data.hot_keywords.forEach(([key, count]) => {
                    if (count > 0) kwContainer.innerHTML += `<span class="keyword-badge ${count >= 3 ? 'hot-keyword' : ''}">#${key} (${count})</span>`;
                });

                renderPosts('signal-stream', data.signals, 'signal-post');
                renderPosts('noise-stream', data.noises, 'noise-post');
            } catch (e) { console.error(e); }
        }

        function renderPosts(containerId, posts, className) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (posts.length === 0) {
                if (className === 'signal-post') {
                    container.innerHTML = `<div class="text-center text-muted py-5" style="border: 1px dashed rgba(255,255,255,0.1); border-radius: 12px;"><i class="fas fa-search-dollar fa-3x mb-3 text-secondary"></i><br><h5 class="text-white">ç›®å‰ç„¡é«˜åƒ¹å€¼è¨Šè™Ÿ</h5><small>AI æ­£åœ¨å¾ PTTã€é‰…äº¨ç¶²ã€å‹•å€ éæ¿¾ä¸­...</small></div>`;
                } else {
                    container.innerHTML = `<div class="text-center text-muted py-5">æš«ç„¡å™ªéŸ³æ•¸æ“š</div>`;
                }
                return;
            }

            posts.forEach(post => {
                let badge = post.sentiment === 'BULLISH' ? '<span class="badge bg-success">çœ‹å¤š</span>' : (post.sentiment === 'BEARISH' ? '<span class="badge bg-danger">çœ‹ç©º</span>' : '');
                
                let qScore = post.quality_score;
                let qColor = qScore >= 80 ? 'text-warning border-warning' : 'text-primary border-primary';
                let scoreBadge = className === 'signal-post' ? `<span class="badge bg-transparent ${qColor} border ms-1" title="Quality Score">Q: ${qScore}</span>` : '';
                
                // ç¢ºä¿ AI æ‘˜è¦ä¸€å®šé¡¯ç¤º
                let aiSummaryText = post.ai_summary || "AI æ­£åœ¨åˆ†æå…§å®¹...";
                let aiSummary = className === 'signal-post' ? `<div class="mt-2 p-2 rounded small text-info" style="background: rgba(56, 189, 248, 0.1);"><i class="fas fa-robot me-1"></i> ${aiSummaryText}</div>` : '';
                
                // ä¾†æºæ¨™ç±¤
                let sourceBadge = '';
                if (post.source === 'CNYES') sourceBadge = `<span class="badge bg-info text-dark me-2">é‰…äº¨ç¶²</span>`;
                else if (post.source === 'BlockTempo') sourceBadge = `<span class="badge bg-warning text-dark me-2">å‹•å€</span>`;
                else sourceBadge = `<span class="badge bg-dark border border-secondary text-muted me-2">PTT</span>`;

                let titleHtml = post.title;
                if(className === 'signal-post') {
                    ["æƒ…å ±", "æ–°è", "åˆ†æ", "BTC", "ETH", "ETF"].forEach(kw => {
                        titleHtml = titleHtml.replace(new RegExp(kw, 'gi'), `<span class="text-warning fw-bold">${kw}</span>`);
                    });
                }

                container.innerHTML += `
                    <div class="post-card ${className}">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <div class="d-flex align-items-center">${sourceBadge} <span>${post.author}</span></div>
                            <div>${badge} ${scoreBadge}</div>
                        </div>
                        <h5 class="mt-1 mb-2" style="font-size: 1.1rem;"><a href="${post.link}" target="_blank" class="post-link">${titleHtml}</a></h5>
                        ${aiSummary}
                        <div class="d-flex justify-content-between align-items-center mt-2 text-muted small">
                            <span>${post.date}</span><span>${post.push} ç†±åº¦</span>
                        </div>
                    </div>`;
            });
        }
        fetchSocialData(); setInterval(fetchSocialData, 10000);
    </script>
</body>
</html>